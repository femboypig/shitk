<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вход или регистрация</title>
    <link rel="stylesheet" href="/styles.css">
    <script>
    </script>

        <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD0ksObwMb6BBZN3WQBYDTLEKNHdG3fr3U",
        authDomain: "shitk-p.firebaseapp.com",
        databaseURL: "https://shitk-p-default-rtdb.firebaseio.com",
        projectId: "shitk-p",
        storageBucket: "shitk-p.firebasestorage.app",
        messagingSenderId: "860946224153",
        appId: "1:860946224153:web:cc1d2b7df27e434f9e0688"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
</script>
</head>
<body>
    <div class="container">
        <h1>Вход или регистрация</h1>
        
        <div class="login-buttons">
            <!-- VK ID button container -->
            <div>
                <script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
                <script type="text/javascript">
                  if ('VKIDSDK' in window) {
                    const VKID = window.VKIDSDK;
              
                    VKID.Config.init({
                      app: 53025022,
                      redirectUrl: 'https://shitk-p.vercel.app',
                      responseMode: VKID.ConfigResponseMode.Callback,
                      source: VKID.ConfigSource.LOWCODE,
                      scope: '', // Заполните нужными доступами по необходимости
                    });
              
                    const oneTap = new VKID.OneTap();
              
                    oneTap.render({
                      container: document.currentScript.parentElement,
                      showAlternativeLogin: true
                    })
                    .on(VKID.WidgetEvents.ERROR, vkidOnError)
                    .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, function (payload) {
                      const code = payload.code;
                      const deviceId = payload.device_id;
              
                      VKID.Auth.exchangeCode(code, deviceId)
                        .then(vkidOnSuccess)
                        .catch(vkidOnError);
                    });
                    function vkidOnSuccess(data) {
                        console.log('Raw VK data received:', data);
                        
                        // Преобразуем данные из VK в нужный формат
                        const vkUserData = {
                            user_id: data.user_id,
                            first_name: data.first_name || '',
                            last_name: data.last_name || '',
                            photo_url: data.photo_url || '',
                            email: data.email || ''
                        };
                        
                        fetch('/auth/vk/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                user_id: data.user_id
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Объединяем данные от VK и сервера
                                const combinedUserData = {
                                    ...vkUserData,
                                    ...data.user
                                };
                                
                                // Save user data to localStorage
                                localStorage.setItem('vk_user', JSON.stringify(combinedUserData));
                                localStorage.setItem('logged', 'true');
                                
                                // Save user data to Firestore
                                return saveUserToFirestore(combinedUserData)
                                    .then(() => {
                                        const redirectPath = localStorage.getItem('redirect_after_login');
                                        if (redirectPath) {
                                            localStorage.removeItem('redirect_after_login');
                                            window.location.href = redirectPath;
                                        } else {
                                            window.location.href = '/dashboard';
                                        }
                                    });
                            } else {
                                throw new Error(data.error || 'Authentication failed');
                            }
                        })
                        .catch(error => {
                            console.error('Auth error:', error);
                            alert('Ошибка авторизации: ' + error.message);
                        });
                    }

                    function vkidOnError(error) {
                        console.error('VK ID Error details:', error);
                        window.location.href = `/error?error=${encodeURIComponent(error.message || 'Неизвестная ошибка')}`;
                    }
                  }
                </script>
              </div>
            
            <button class="google-button">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18.171 8.368h-.67v-.035H10v3.333h4.709A4.998 4.998 0 0 1 5 10a5 5 0 0 1 5-5c1.275 0 2.434.48 3.317 1.266l2.357-2.357A8.295 8.295 0 0 0 10 2C5.582 2 2 5.582 2 10s3.582 8 8 8c4.418 0 8-3.582 8-8 0-.553-.057-1.093-.166-1.613z" fill="#fff"/>
                </svg>
                Войти через Google
            </button>
            
            <div class="email-input">
                <input type="email" placeholder="Адрес электронной почты" />
                <button class="code-button">Получить код</button>
            </div>
        </div>

        <div class="terms">
            Продолжая регистрацию или вход, вы принимаете условия 
            <a href="/terms">Пользовательского соглашения</a> и 
            <a href="/privacy">Политики конфиденциальности</a>
        </div>
    </div>

    <script>
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0,
                    v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function saveUserToFirestore(userData) {
            if (!userData) {
                console.error('Invalid user data:', userData);
                return Promise.reject(new Error('Invalid user data'));
            }

            const firestore = firebase.firestore();
            const uniqueId = generateUUID();
            const userRef = firestore.collection('users').doc(uniqueId);

            const userDataToSave = {
                uid: uniqueId,
                vk_id: String(userData.user_id || ''),
                first_name: userData.first_name || '',
                last_name: userData.last_name || '',
                email: userData.email || '',
                photo_url: userData.photo_url || '',
                isAdmin: false,
                created_at: firebase.firestore.FieldValue.serverTimestamp(),
                last_login: firebase.firestore.FieldValue.serverTimestamp()
            };

            return userRef.set(userDataToSave, { merge: true })
                .then(() => {
                    // Сохраняем uid в localStorage вместе с остальными данными пользователя
                    const updatedUserData = { ...userData, uid: uniqueId };
                    localStorage.setItem('vk_user', JSON.stringify(updatedUserData));
                    console.log('User data saved to Firestore');
                    return updatedUserData;
                })
                .catch(error => {
                    console.error('Error saving user to Firestore:', error);
                    throw error;
                });
        }
    </script>


</body>
</html> 